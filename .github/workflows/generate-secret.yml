name: Generate Session Secret

on:
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  generate-secret:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Random Session Secret
        id: generate_secret
        run: echo "SESSION_SECRET=$(openssl rand -hex 32)" >> $GITHUB_ENV

      - name: Save Secret to GitHub Repository Secrets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PUBKEY=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key)
          echo $PUBKEY | jq .
          KEY_ID=$(echo $PUBKEY | jq -r .key_id)
          ENCRYPTED_SECRET=$(echo -n "${{ steps.generate_secret.outputs.SESSION_SECRET }}" | openssl rsautl -encrypt -pubin -inkey <(echo "$PUBKEY" | jq -r .key) | base64)
          curl -X PUT -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"encrypted_value\":\"$ENCRYPTED_SECRET\",\"key_id\":\"$KEY_ID\"}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/SESSION_SECRET

      - name: Output Session Secret
        run: echo "Generated SESSION_SECRET successfully stored in GitHub Secrets."
